<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Reactive Lissajous - „Ç™„Éº„Éá„Ç£„Ç™„É™„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éª„É™„Çµ„Éº„Ç∏„É•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        h1 {
            color: #fff;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            text-align: center;
        }

        .subtitle {
            color: #aaa;
            font-size: clamp(0.8rem, 2vw, 1rem);
            margin-bottom: 20px;
            text-align: center;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 1;
            margin-bottom: 20px;
        }

        canvas {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            width: 100%;
            max-width: 800px;
        }

        button {
            padding: 12px 24px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.5);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ff6b6b 0%, #cc5555 100%);
            color: #fff;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.5);
        }

        .settings {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            width: 100%;
            max-width: 800px;
        }

        .setting {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .setting label {
            color: #fff;
            font-size: 0.9rem;
        }

        .setting input[type="range"] {
            width: 120px;
            accent-color: #00d4ff;
        }

        .setting span {
            color: #00d4ff;
            font-weight: bold;
            min-width: 30px;
        }

        .audio-status {
            color: #0f0;
            font-size: 0.9rem;
            text-align: center;
            margin-top: 10px;
        }

        .fullscreen-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px 15px;
            background: rgba(0, 212, 255, 0.8);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        @media (max-width: 600px) {
            .settings {
                flex-direction: column;
                align-items: center;
            }

            .setting {
                width: 100%;
            }

            .setting input[type="range"] {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <button class="fullscreen-btn" onclick="toggleFullscreen()">ÂÖ®ÁîªÈù¢</button>

    <div class="container">
        <h1>üéµ Audio Reactive Lissajous</h1>
        <p class="subtitle">Èü≥Ê•Ω„Å´Âêà„Çè„Åõ„Å¶Áæé„Åó„ÅèÂ§âÂåñ„Åô„Çã„É™„Çµ„Éº„Ç∏„É•Âõ≥ÂΩ¢</p>

        <div class="canvas-container">
            <canvas id="canvas"></canvas>
        </div>

        <div class="controls">
            <button class="btn-primary" id="startBtn">üé§ „Éû„Ç§„ÇØÈñãÂßã</button>
            <button class="btn-secondary" id="stopBtn">‚èπÔ∏è ÂÅúÊ≠¢</button>
        </div>

        <div class="settings">
            <div class="setting">
                <label>Âë®Ê≥¢Êï∞A: <span id="freqAValue">3</span></label>
                <input type="range" id="freqA" min="1" max="10" step="0.5" value="3">
            </div>
            <div class="setting">
                <label>Âë®Ê≥¢Êï∞B: <span id="freqBValue">2</span></label>
                <input type="range" id="freqB" min="1" max="10" step="0.5" value="2">
            </div>
            <div class="setting">
                <label>‰ΩçÁõ∏: <span id="phaseValue">0</span></label>
                <input type="range" id="phase" min="0" max="360" step="1" value="0">
            </div>
            <div class="setting">
                <label>ÈÄüÂ∫¶: <span id="speedValue">1.0</span></label>
                <input type="range" id="speed" min="0.1" max="3" step="0.1" value="1.0">
            </div>
            <div class="setting">
                <label>„Éà„É¨„Ç§„É´: <span id="trailValue">0.95</span></label>
                <input type="range" id="trail" min="0.8" max="0.99" step="0.01" value="0.95">
            </div>
        </div>

        <div class="audio-status" id="audioStatus">„Éû„Ç§„ÇØ„Ç™„Éï</div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let audioContext;
        let analyser;
        let microphone;
        let dataArray;
        let isRunning = false;
        let time = 0;

        let freqA = 3;
        let freqB = 2;
        let phase = 0;
        let speed = 1.0;
        let trail = 0.95;

        function resize() {
            const container = canvas.parentElement;
            const size = Math.min(container.clientWidth, container.clientHeight);
            canvas.width = size;
            canvas.height = size;
        }

        window.addEventListener('resize', resize);
        resize();

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        document.getElementById('freqA').addEventListener('input', (e) => {
            freqA = parseFloat(e.target.value);
            document.getElementById('freqAValue').textContent = freqA.toFixed(1);
        });

        document.getElementById('freqB').addEventListener('input', (e) => {
            freqB = parseFloat(e.target.value);
            document.getElementById('freqBValue').textContent = freqB.toFixed(1);
        });

        document.getElementById('phase').addEventListener('input', (e) => {
            phase = parseFloat(e.target.value);
            document.getElementById('phaseValue').textContent = phase;
        });

        document.getElementById('speed').addEventListener('input', (e) => {
            speed = parseFloat(e.target.value);
            document.getElementById('speedValue').textContent = speed.toFixed(1);
        });

        document.getElementById('trail').addEventListener('input', (e) => {
            trail = parseFloat(e.target.value);
            document.getElementById('trailValue').textContent = trail.toFixed(2);
        });

        document.getElementById('startBtn').addEventListener('click', async () => {
            if (isRunning) return;

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);

                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isRunning = true;
                document.getElementById('audioStatus').textContent = '‚úì „Éû„Ç§„ÇØ„Ç™„É≥';
                document.getElementById('startBtn').disabled = true;

                animate();
            } catch (err) {
                console.error('„Éû„Ç§„ÇØ„Ç¢„ÇØ„Çª„Çπ„Ç®„É©„Éº:', err);
                document.getElementById('audioStatus').textContent = '‚úó „Éû„Ç§„ÇØ„Ç®„É©„Éº: ' + err.message;
            }
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            isRunning = false;
            if (microphone) {
                microphone.disconnect();
            }
            if (audioContext) {
                audioContext.close();
            }
            document.getElementById('audioStatus').textContent = '„Éû„Ç§„ÇØ„Ç™„Éï';
            document.getElementById('startBtn').disabled = false;
        });

        function getAudioLevel() {
            if (!isRunning || !analyser) return 0;

            analyser.getByteFrequencyData(dataArray);
            const sum = dataArray.reduce((a, b) => a + b, 0);
            return sum / dataArray.length / 255;
        }

        function getFrequencyBands() {
            if (!isRunning || !analyser) return { bass: 0, mid: 0, high: 0 };

            analyser.getByteFrequencyData(dataArray);

            const bass = dataArray.slice(0, 10).reduce((a, b) => a + b, 0) / 10 / 255;
            const mid = dataArray.slice(10, 50).reduce((a, b) => a + b, 0) / 40 / 255;
            const high = dataArray.slice(50, 100).reduce((a, b) => a + b, 0) / 50 / 255;

            return { bass, mid, high };
        }

        function hslToRgb(h, s, l) {
            let r, g, b;

            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };

                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }

            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }

        function drawLissajous(bass, mid, high) {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const size = Math.min(canvas.width, canvas.height) * 0.4;

            // Èü≥„Å´Âøú„Åò„Å¶„Éë„É©„É°„Éº„Çø„ÇíÂ§âÂåñ
            const modFreqA = freqA + bass * 2;
            const modFreqB = freqB + mid * 2;
            const modPhase = phase + high * 180;
            const modSize = size * (1 + bass * 0.3);

            // Ëâ≤„ÅØÊôÇÈñì„Å®Èü≥„ÅÆ„É¨„Éô„É´„Å´Âøú„Åò„Å¶Â§âÂåñ
            const hue = (time * 20 + bass * 100 + mid * 50) % 360;
            const saturation = 70 + high * 30;
            const lightness = 40 + bass * 30;

            ctx.beginPath();
            ctx.strokeStyle = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            ctx.lineWidth = 3 + high * 3;

            for (let t = 0; t <= Math.PI * 2; t += 0.01) {
                const x = centerX + modSize * Math.sin(modFreqA * t + modPhase * Math.PI / 180);
                const y = centerY + modSize * Math.sin(modFreqB * t);

                if (t === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }

            ctx.closePath();
            ctx.stroke();

            // „Ç∞„É≠„ÉºÂäπÊûú
            ctx.shadowBlur = 20 + high * 30;
            ctx.shadowColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            ctx.stroke();
            ctx.shadowBlur = 0;

            // 2Â±§ÁõÆ„ÅÆÂõ≥ÂΩ¢ÔºàÂ∞ë„ÅóÂ∞è„Åï„Åè„ÄÅ‰ΩçÁõ∏„Åå„Åö„Çå„ÇãÔºâ
            ctx.beginPath();
            ctx.strokeStyle = `hsl(${(hue + 60) % 360}, ${saturation}%, ${lightness}%)`;
            ctx.lineWidth = 2 + mid * 2;

            for (let t = 0; t <= Math.PI * 2; t += 0.01) {
                const x = centerX + modSize * 0.7 * Math.sin(modFreqA * t + (modPhase + 30) * Math.PI / 180);
                const y = centerY + modSize * 0.7 * Math.sin(modFreqB * t);

                if (t === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }

            ctx.closePath();
            ctx.stroke();
        }

        function drawParticles(bass, mid, high) {
            const particleCount = 50;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const size = Math.min(canvas.width, canvas.height) * 0.4;

            for (let i = 0; i < particleCount; i++) {
                const angle = (i / particleCount) * Math.PI * 2 + time * 0.5;
                const radius = size * (1.2 + bass * 0.3);
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;

                const particleSize = 2 + high * 4;
                const hue = (time * 30 + i * 10) % 360;

                ctx.beginPath();
                ctx.arc(x, y, particleSize, 0, Math.PI * 2);
                ctx.fillStyle = `hsl(${hue}, 80%, 60%)`;
                ctx.fill();
            }
        }

        function animate() {
            if (!isRunning) return;

            const { bass, mid, high } = getFrequencyBands();

            // „Éà„É¨„Ç§„É´ÂäπÊûú
            ctx.fillStyle = `rgba(10, 10, 10, ${1 - trail})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawParticles(bass, mid, high);
            drawLissajous(bass, mid, high);

            time += 0.01 * speed;
            requestAnimationFrame(animate);
        }

        // „Éá„É¢„É¢„Éº„ÉâÔºà„Éû„Ç§„ÇØ„Åå‰Ωø„Åà„Å™„ÅÑÂ†¥ÂêàÔºâ
        function demoMode() {
            if (isRunning) return;

            ctx.fillStyle = `rgba(10, 10, 10, ${1 - trail})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const bass = Math.sin(time * 2) * 0.5 + 0.5;
            const mid = Math.sin(time * 3) * 0.5 + 0.5;
            const high = Math.sin(time * 5) * 0.5 + 0.5;

            drawParticles(bass, mid, high);
            drawLissajous(bass, mid, high);

            time += 0.01 * speed;
            requestAnimationFrame(demoMode);
        }

        demoMode();
    </script>
</body>
</html>
